---
author: "Adri√°n & Solveig"
title: "Permutation"
output: html_document
---

```{r}
# Load libraries
# library(tidyverse)
```


#Permutation basis:
Mean, define number of permutaions, 10000 being default value.
Define dataset, the column name for the column with the different categories you want to compare means for and the name of the columns with the counts.
The names of the groups/categories.

### Permute mean

```{r}
permutation_mean <- function(dataset, name, count, group1, group2, no_perm=10000, plot=FALSE){
# Select columns in the dataset and remane those
  dataset <- dataset[c(count,name)]      # Select
  names(dataset) <- c("count","name")    # Rename
  
  r <- rep(NA,no_perm)
  
  # Progress bar
  pb <- txtProgressBar(min = 1, max = no_perm, style = 3)
  
  for (i in 1:length(r)) {
    setTxtProgressBar(pb, i)
    #shuffle dataset
    p <- dataset
    p$count <- sample(p$count)

    #calculate median for group 1 and group 2
    g1 <- mean(p[which(p$name == group1),]$count)
    g2 <- mean(p[which(p$name == group2),]$count)

    #add difference in median to vector
    r[i] <- as.numeric(g1) - as.numeric(g2)
  }
  close(pb)

  # The observed difference
  m1 <- mean(dataset[which(dataset$name == group1),]$count)
  m2 <- mean(dataset[which(dataset$name == group2),]$count)
  observed <- m1-m2       # Observed mean

  estimate <- c(as.numeric(m1),as.numeric(m2),as.numeric(observed))
  names(estimate) <- c("Mean first group","Mean second group","Observed mean difference")

  # P-value
  p_value <- ((sum(abs(r) >= abs(observed))+1)/(length(r)+1))
  names(p_value) <- "p-value"

  result = list(method = "Permutation Test (Mean)", p.value = p_value,
                  estimate = estimate,
                  data.name = sprintf("Permutation for group: %s and %s", group1, group2))
  class(result) <- "htest"

  # If statement to plot or not
  if (plot == TRUE) {
    # Plot + result

    # plot <- PLOT_PERMUTE(r,observed)!!!

    print(result)
    # return(plot)
  } else if (plot == FALSE) {
    # Result
    print(result)
  }
}


names <- c(replicate(50,"Something"), replicate(50, "Something_else"))
test <- as.tibble(rnorm(100)) %>% mutate(names=names)

permutation_mean(test, "names", "value", "Something", "Something_else", plot = FALSE)

```


### Permutation median:

```{r}
permutation_median <- function(dataset, name, count, group1, group2, no_perm=10000, plot=FALSE) {
  # Select columns in the dataset and remane those
  dataset <- dataset[c(count,name)]      # Select
  names(dataset) <- c("count","name")    # Rename
  
  r <- rep(NA,no_perm)
  
  # Progress bar
  pb <- txtProgressBar(min = 1, max = no_perm, style = 3)
  
  for (i in 1:length(r)) {
    setTxtProgressBar(pb, i)
    #shuffle dataset
    p <- dataset
    p$count <- sample(p$count)

    #calculate median for group 1 and group 2
    g1 <- median(p[which(p$name == group1),]$count)
    g2 <- median(p[which(p$name == group2),]$count)

    #add difference in median to vector
    r[i] <- as.numeric(g1) - as.numeric(g2)
  }
  close(pb)
  
  # The observed difference
  m1 <- median(dataset[which(dataset$name == group1),]$count)
  m2 <- median(dataset[which(dataset$name == group2),]$count)
  observed <- m1-m2       # Observed median

  estimate <- c(as.numeric(m1),as.numeric(m2),as.numeric(observed))
  names(estimate) <- c("Median first group","Median second group","Observed median difference")

  # P-value
  p_value <- ((sum(abs(r) >= abs(observed))+1)/(length(r)+1))
  names(p_value) <- "p-value"

  result = list(method = "Permutation Test (Median)", p.value = p_value,
                  estimate = estimate,
                  data.name = sprintf("Permutation for group: %s and %s", group1, group2))
  class(result) <- "htest"

  # If statement to plot or not
  if (plot == TRUE) {
    # Plot + result

    # plot <- PLOT_PERMUTE()!!!

    print(result)
    # return(plot)
  } else if (plot == FALSE) {
    # Result
    print(result)
  }
}

names <- c(replicate(50,"GROUP1"), replicate(50, "GROUP2"))
test <- as_tibble(rnorm(100)) %>% mutate(names=names)

permutation_median(test, "names", "value", "GROUP1", "GROUP2", plot = F)
```


