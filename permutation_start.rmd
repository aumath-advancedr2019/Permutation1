---
author: "Adri√°n & Solveig"
title: "Permutation"
output: html_document
---

```{r}
# Load libraries
# library(tidyverse)
```


#Permutation mean:
Mean, define number of permutaions, 10000 being default value.
Define dataset, the column name for the column with the different categories you want to compare means for and the name of the columns with the counts.
The names of the groups/categories.

### Permute mean

```{r}
permutation_mean <- function(dataset, name, count, group1, group2, no_perm=10000, plot=FALSE){
# Select columns in the dataset and remane those
  dataset <- dataset[c(count,name)]      # Select
  names(dataset) <- c("count","name")    # Rename
  
  r <- rep(NA,no_perm)
  
  # Progress bar
  pb <- txtProgressBar(min = 1, max = no_perm, style = 3)
  
  for (i in 1:length(r)) {
    setTxtProgressBar(pb, i)
    #shuffle dataset
    p <- dataset
    p$count <- sample(p$count)

    #calculate median for group 1 and group 2
    g1 <- mean(p[which(p$name == group1),]$count)
    g2 <- mean(p[which(p$name == group2),]$count)

    #add difference in median to vector
    r[i] <- as.numeric(g1) - as.numeric(g2)
  }
  close(pb)

  # The observed difference
  m1 <- mean(dataset[which(dataset$name == group1),]$count)
  m2 <- mean(dataset[which(dataset$name == group2),]$count)
  observed <- m1-m2       # Observed mean

  estimate <- c(as.numeric(m1),as.numeric(m2),as.numeric(observed))
  names(estimate) <- c("Mean first group","Mean second group","Observed mean difference")

  # P-value
  p_value <- ((sum(abs(r) >= abs(observed))+1)/(length(r)+1))
  names(p_value) <- "p-value"

  result = list(method = "Permutation Test (Mean)", p.value = p_value,
                  estimate = estimate,
                  data.name = sprintf("Permutation for group: %s and %s", group1, group2))
  class(result) <- "htest"

  # If statement to plot or not
  if (plot == TRUE) {
    # Plot + result

    # plot <- PLOT_PERMUTE(r,observed)!!!

    print(result)
    # return(plot)
  } else if (plot == FALSE) {
    # Result
    print(result)
  }
}


names <- c(replicate(50,"Something"), replicate(50, "Something_else"))
test <- as.tibble(rnorm(100)) %>% mutate(names=names)

permutation_mean(test, "names", "value", "Something", "Something_else", plot = FALSE)

```


### Permutation median:

```{r}
permutation_median <- function(dataset, name, count, group1, group2, no_perm=10000, plot=FALSE) {
  # Select columns in the dataset and remane those
  dataset <- dataset[c(count,name)]      # Select
  names(dataset) <- c("count","name")    # Rename
  
  r <- rep(NA,no_perm)
  
  # Progress bar
  pb <- txtProgressBar(min = 1, max = no_perm, style = 3)
  
  for (i in 1:length(r)) {
    setTxtProgressBar(pb, i)
    #shuffle dataset
    p <- dataset
    p$count <- sample(p$count)

    #calculate median for group 1 and group 2
    g1 <- median(p[which(p$name == group1),]$count)
    g2 <- median(p[which(p$name == group2),]$count)

    #add difference in median to vector
    r[i] <- as.numeric(g1) - as.numeric(g2)
  }
  close(pb)
  
  # The observed difference
  m1 <- median(dataset[which(dataset$name == group1),]$count)
  m2 <- median(dataset[which(dataset$name == group2),]$count)
  observed <- m1-m2       # Observed median

  estimate <- c(as.numeric(m1),as.numeric(m2),as.numeric(observed))
  names(estimate) <- c("Median first group","Median second group","Observed median difference")

  # P-value
  p_value <- ((sum(abs(r) >= abs(observed))+1)/(length(r)+1))
  names(p_value) <- "p-value"

  result = list(method = "Permutation Test (Median)", p.value = p_value,
                  estimate = estimate,
                  data.name = sprintf("Permutation for group: %s and %s", group1, group2))
  class(result) <- "htest"

  # If statement to plot or not
  if (plot == TRUE) {
    # Plot + result

    # plot <- PLOT_PERMUTE()!!!

    print(result)
    # return(plot)
  } else if (plot == FALSE) {
    # Result
    print(result)
  }
}

names <- c(replicate(50,"GROUP1"), replicate(50, "GROUP2"))
test <- as_tibble(rnorm(100)) %>% mutate(names=names)

permutation_median(test, "names", "value", "GROUP1", "GROUP2", plot = F)
```

#Permutation linear model comparison
Permutation that uses the F-distribution to compare two of three linear models (linear, quadratic or cubic).
It needs a dataset and the names of the columns with the predictor and the response values and the kind of models to compare.

```{r}
permutation_lm <- function(dataset, predictor, response, model1, model2, no_perm=10000, plot=F){
  #permute and save difference in mean per round
  dataset <- dataset %>% rename("predictor"=predictor, "response"=response)
  
  r <- rep(NA,no_perm)
  
  #For linear and quadratic model:
  if ((model1=="linear" & model2=="quadratic")|(model2=="linear" & model1=="quadratic")){
    # Observed models:
    mod1 <- lm(response ~ predictor, data=dataset)
    mod2 <- lm(response ~ poly(predictor, 2), data=dataset)
    # Progress bar
    pb <- txtProgressBar(min = 1, max = no_perm, style = 3)
    for (i in 1:length(r)) {
      setTxtProgressBar(pb, i)
      #shuffle dataset
      p <- cbind(pred = dataset$predictor, resp = sample(dataset$response)) %>% 
        as_tibble()
      
      #make models
      m1 <- lm(resp ~ pred, data=p)
      
      m2 <- lm(resp~ poly(pred, 2), data=p)
      
      #make F-distribution
      f_dist <- anova(m1, m2)
      
      #add F-values to r-vector:
      r[i] <- f_dist$`F`[2]
      
    }
    close(pb)
  }
  
  #For linear and cubic model:
  if ((model1=="linear" & model2=="cubic")|(model2=="linear" & model1=="cubic")){
    # Observed models:
    mod1 <- lm(response ~ predictor, data=dataset)
    mod2 <- lm(response ~ poly(predictor, 3), data=dataset)
    # Progress bar
    pb <- txtProgressBar(min = 1, max = no_perm, style = 3)
    for (i in 1:length(r)) {
      setTxtProgressBar(pb, i)
      #shuffle dataset
      p <- cbind(pred = dataset$predictor, resp = sample(dataset$response)) %>% 
        as_tibble()
      
      #make models
      m1 <- lm(resp ~ pred, data=p)
      
      m2 <- lm(resp~ poly(pred, 3), data=p)
      
      #make F-distribution
      f_dist <- anova(m1, m2)
      
      #add F-values to r-vector:
      r[i] <- f_dist$`F`[2]
      
    }
    close(pb)
  }
  
  #For quadratic and qubic model:
  if ((model1=="quadratic" & model2=="cubic")|(model2=="quadratic" & model1=="cubic")){
    # Observed models:
    mod1 <- lm(response ~ poly(predictor,2), data=dataset)
    mod2 <- lm(response ~ poly(predictor, 3), data=dataset)
    # Progress bar
    pb <- txtProgressBar(min = 1, max = no_perm, style = 3)
    for (i in 1:length(r)) {
      setTxtProgressBar(pb, i)
      #shuffle dataset
      p <- cbind(pred = dataset$predictor, resp = sample(dataset$response)) %>% 
        as_tibble()
      
      #make models
      m1 <- lm(resp ~ poly(pred,2), data=p)
      
      m2 <- lm(resp~ poly(pred, 3), data=p)
      
      #make F-distribution
      f_dist <- anova(m1, m2)
      
      #add F-values to r-vector:
      r[i] <- f_dist$`F`[2]
      
    }
    close(pb)
  }
  #create df with values for null distribution
  pd <- data.frame(i=1:length(r), value=r) %>% 
    tbl_df()
  
  #the observed 
  observed <- anova(mod1, mod2)$`F`[2]
  
  #plotting the null distribution and observed difference with the observed as a line
  plot <- ggplot(data = pd, mapping = aes(x=value)) + 
    geom_histogram(fill="darkblue", bins=50) +
    geom_vline(color="darkorange",xintercept = as.numeric(observed)) + 
    xlab("")+
    ylab("Count")+
    theme_minimal()
  
  #permuted p-value. 1 is added because we always expect the next one to be significant (of permuted values)
  p_value <- ((sum((r) >= (observed))+1)/(length(r)+1))
  return (list(p_value, plot))
}

```

Testing data:
```{r}
x <- rnorm(100)
y <- 4*x^2+3+rnorm(length(x),sd=15)
data <- data.frame(x,y)

plot(data)

permutation_lm(data, "x","y","quadratic", "linear", plot=T)
permutation_lm(data, "x","y","quadratic", "cubic", plot=T)
```

